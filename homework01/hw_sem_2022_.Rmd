---
title: "Домашно задание по СЕМ практикум"
author: "Давид Петров, СИ, гр. 4, ф.н. 62596"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
    toc: false
    toc_float: true
    number_sections: false
  pdf_document: default
  word_document: default
---

<br>

При решаване на задачите може да използвате вградени функции и команди, които **не** изискват зареждане на пакет или извикване от типа `packageName::fun()`.

<br>

### Задача 1

В тесте от $32$ карти има $4$ маркирани. Тестето е разбъркано и раздадено на $4$ играчи. Чрез подходяща симулация намерете приближение на вероятността на събитието *"на всеки играч се пада една маркирана карта"*.

## Решение

Ще моделираме аналитично по формулата на Бейс, за да си направим sanity check на емпиричните резултати. Нека за $i \in {1,2,3,4}$ въведем $X_i :=$ брой маркирани карти в ръката (от 8 карти) на $i$-ти играч. Всяко $X_i$ е хипергеометрично разпределена случайна величина, обаче четирите са зависими и трябва да намерим с какви параметри да направим сметката. Реално сумата им е инварианта 4, така че търсим $\mathbb{P}(X_1 = 1; X_2 = 1; X_3 = 1)$. Ползваме Бейс в съвкупност, т.е.: $\mathbb{P}(X_1 = 1; X_2 = 1; X_3 = 1) = \mathbb{P}(X_1 = 1 \mid X_2 = 1; X_3 = 1)\cdot \mathbb{P}(X_2 = 1 \mid X_3 = 1)\cdot \mathbb{P}(X_3 = 1)$ 

Сега вече е лесно: 


$X_3 \sim HG(32, 4, 8)$ 


$X_2 \mid X_3 = 1 \sim HG(24, 3, 8)$ 


$X_1 \mid X_2 = 1; X_3 = 1 \sim HG(16,2,8)$

С леката адаптация към API-а на R, можем директно да оставим сметките на машината:

```{r}
pX3 <- dhyper(1, 4, 32-4, 8)
pX2condX3 <- dhyper(1, 3, 24-3,8)
pX1condX3X2 <- dhyper(1, 2, 16 - 2, 8)
totalP <- pX3 * pX1condX3X2 * pX2condX3
print(totalP)
```

Сега подхождаме по същество към емпиричното задание.

```{r}
marked <- c(1:4)

# симулираме раздаване
sim.deals <- function() {
  # списък от 28 немаркирани и 4 маркирани стойности
  deck <- c(rep(FALSE, 28), rep(TRUE, 4))
  
  # разбъркваме ги случайно
  cards <- sample(deck)
  
  # и раздаваме на 4-ма играчи
  dealsByPlayer <- matrix(cards, nrow=4)
  
  # проверява дали даден играч (ред в матрицата)
  # има маркирана карта
  playerHasMarked <- function(row) {
    any(row)
  }
  
  #' проверяваме дали всеки играч има маркирана карта,
  #' което е еквивалентно на нашата дефиниция за успех,
  #' понеже всеки да има маркирана е възможно т.т.к 
  #' всеки има точно една маркирана
  all(apply(dealsByPlayer, 1, playerHasMarked))
}

# повтаряме симулацията Nrep пъти
# за да приближим вероятността емпирично
prob.deals <- function(Nrep) {
  rs <- replicate(Nrep, sim.deals())
  sum(rs)/length(rs)
}

# приближение със 100 000 повторения
prob.deals(100000)
```
Както можем да забележим, емпиричното приближение е доста дробо след 100000 повторения.


### Задача 2

В кутия има $5$ зелени, $7$ сини и $7$ жълти топки. Симулирайте $n$ тегления на топка с връщане. Проверете хипотезата, че в кутията има еднакъв брой топки от трите цвята. Повторете $10000$ пъти за $n=50, 100, 200, 500, 1000$. Колко често заключението на теста е вярно? Представете чрез подходяща графика честотата на вярно заключение в зависимост от $n$.

Решение:
Ще използваме хи-квадрат тест за съгласуваност за да проверим хипотезата. Пълната група от събития са ни трите възможни резултата при теглене на една топка - зелена, синя или жълта. Ниво на значимост съм фиксирал стандартно 0.05, но лесно може да се промени и да се експериментира. В детайли идеята на решението е описана с коментари в кода:

```{r}
# Векторът от топки, с които разполагаме
balls <- rep(c("green", "blue", "yellow"), c(5, 7, 7))

# Различните големини на извадките за всяка симулация
sample_sizes <- c(50, 100, 200, 500, 1000)

# Броя опити (еднакъв за всеки sample size)
n_trials <- 10000

# Фиксираме ниво на значимост
p_value_threshold <- 0.05

# Функция за симулация на опитите и пресмятане на честота на потвърждение с извадка от n топки респективно
sim.trials = function(sample_size) {
  p.values <- replicate(n_trials, {
    # вадим sample_size на брой топки с връщане
    draws <- sample(balls, size = sample_size, replace = TRUE)
    
    # правим хи-квадрат тест за съгласуваност,
    # от който извличаме необходимата ни P-стойност
    chisq.test(table(draws)) $ p.value
  })
  
  # Броим колко от опитите потвърждават нулевата хипотеза (т.е. че имаме равен брой топки от всеки цвят)
  # което е равносилно на P-стойност > ниво на значимост
  # Търсим честота, така че намерения брой делим на общия брой опити
  sum(p.values > p_value_threshold) / n_trials
}

# За всяко n, пресмятаме честотата на вярно заключение (потвърдена нулева хипотеза)
frequencies <- sapply(sample_sizes, sim.trials)

# Показваме резултатите на хистограма
barplot(frequencies, xlab = "Големина на извадката (n)", ylab = "Честота на вярно заключение", main = "Хистограма на честотите", names.arg = sample_sizes, ylim = c(0, 1))

# Допълнителна команда за извеждане на точните честоти над колоните на хистограмата
text(x = 1:length(sample_sizes), y = frequencies, labels = round(frequencies, 3), pos = 3, cex = 0.8)
```


Получаваме очакван резултат - с нарастване на големината на една извадка получаваме все по-категорично отхвърляне на хипотезата, че имаме по равен брой топки от всеки цвят. Тенденцията се запазва и с различни стойности на нивото на значимост.

### Задача 3

В кутия има $5$ зелени, $5$ сини и $5$ жълти топки. Симулирайте $n$ тегления на топка с връщане. Проверете хипотезата, че в кутията има еднакъв брой топки от трите цвята. Повторете $10000$ пъти за $n=50, 100, 200, 500, 1000$. Колко често заключението на теста е вярно? Представете чрез подходяща графика честотата на вярно заключение в зависимост от $n$.

Решение:
За решението тук кодът е почти същия, само сме променили броя на топките (спрямо условието), абсцисата съм вдигнал до 1.2 (макар да са невъзможни тези стойности) за да излиза добре визуално

```{r}
# Векторът от топки, с които разполагаме
balls <- rep(c("green", "blue", "yellow"), c(5, 5, 5))

# Различните големини на извадките за всяка симулация
sample_sizes <- c(50, 100, 200, 500, 1000)

# Броя опити (еднакъв за всеки sample size)
n_trials <- 10000

# Фиксираме ниво на значимост
p_value_threshold <- 0.01

# Функция за симулация на опитите и пресмятане на честота на потвърждение с извадка от n топки респективно
sim.trials = function(sample_size) {
  p.values <- replicate(n_trials, {
    # вадим sample_size на брой топки с връщане
    draws <- sample(balls, size = sample_size, replace = TRUE)
    
    # правим хи-квадрат тест за съгласуваност,
    # от който извличаме необходимата ни P-стойност
    chisq.test(table(draws)) $ p.value
  })
  
  # Броим колко от опитите потвърждават нулевата хипотеза (т.е. че имаме равен брой топки от всеки цвят)
  # което е равносилно на P-стойност > ниво на значимост
  # Търсим честота, така че намерения брой делим на общия брой опити
  sum(p.values > p_value_threshold) / n_trials
}

# За всяко n, пресмятаме честотата на вярно заключение (потвърдена нулева хипотеза)
frequencies <- sapply(sample_sizes, sim.trials)

# Показваме резултатите на хистограма
barplot(frequencies, xlab = "Големина на извадката (n)", ylab = "Честота на вярно заключение", main = "Хистограма на честотите", names.arg = sample_sizes, ylim = c(0, 1.2))

# Допълнителна команда за извеждане на точните честоти над колоните на хистограмата
text(x = 1:length(sample_sizes), y = frequencies, labels = round(frequencies, 3), pos = 3, cex = 0.8)
```


Тук също получаваме очакван резултат - понеже хипотезата е вярна, то увеличаването на големината на извадката потвърждава тази тенденция. Ако трябва да съм честен, имах и очакването да видя по-голямо нарастване на честотата на вярно заключение, но предвид, че хипотезата е вярна, може би е естествено и с малки извадки да сме сравнително доста сигурни. Важното е с нарастване на големината на извадката сигурността ни да остава все така висока.